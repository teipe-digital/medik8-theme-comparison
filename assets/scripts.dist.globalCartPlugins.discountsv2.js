(()=>{"use strict";var t={d:(e,i)=>{for(var s in i)t.o(i,s)&&!t.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:i[s]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{DiscountsV2Util:()=>DiscountsV2Util,GlobalFreeGiftToggle:()=>GlobalFreeGiftToggle});class DiscountsV2Util{constructor(t){if(this.singleton$=new ObserverLite({key:"DiscountsV2Util$"}),!t)return new Promise((async(t,e)=>{t(await this.singleton$.once())}));this.settings=t,this.singleton$.next(this)}async bindData(){this.GlobalCart=await new GlobalCart;const t=new ObserverLite({key:"V2discountTiers$"});this.DiscountTierMetafields=await t.once()}discountStatusCheck(t,e,i){const s=new Date;return"ACTIVE"==t&&(!i||i&&new Date(i)>s)||"SCHEDULED"==t&&e&&s>=new Date(e)&&i&&s<new Date(i)}async get_ActiveTieredDiscount(){await this.bindData();const t=await this.get_AppliedTierDiscount();if(t?.showInAov){const{status:e,startsAt:i,endsAt:s}=t;if(this.discountStatusCheck(e,i,s))return t}let e=this.DiscountTierMetafields;e=e.filter((({status:t,startsAt:e,endsAt:i})=>this.discountStatusCheck(t,e,i)))||!1;const{customer:i}=this.settings;return e=e.filter((({discountMethod:t,customerTags:e})=>{if("Automatic"!=t)return!1;if(e?.length){const t=i?.tags.map((t=>t.toLowerCase()))||!1,s=e.map((t=>t.toLowerCase()));return!(!t||!t.some((t=>s.includes(t))))}return!0})).sort(((t,e)=>{const i=t.tiers.sort(((t,e)=>parseFloat(e.amount)-parseFloat(t.amount)))[0],s=e.tiers.sort(((t,e)=>parseFloat(e.amount)-parseFloat(t.amount)))[0];return parseFloat(s.amount)-parseFloat(i.amount)})),!!e.length&&e[0]}async get_ActiveProgressBarTierDiscount(){let t=await this.get_ActiveTieredDiscount();return!!t.showInAov&&t}async get_AppliedTierDiscount(){await this.bindData();let t=this.DiscountTierMetafields,e=await this.GlobalCart.getAllDiscountCodes();return e=!!e&&e.split(":")[0],t?.find((({discountTitle:t})=>t==e))||!1}updateSoldOutItems(t){t=t.map((({variant_id:t})=>t));let e=this.getSoldOutItems();t=[...t,...e],sessionStorage.setItem("td2SoldOutFreeGWP",JSON.stringify([...new Set(t)]))}getSoldOutItems(){let t=sessionStorage.getItem("td2SoldOutFreeGWP");if(t)try{t=JSON.parse(t)}catch(e){t=[]}else t=[];return t}async updateCartFreeGifts(){await this.bindData();const t=await this.get_ActiveTieredDiscount(),e=await this.GlobalCart.get_CartTotalMinusFreeGifts(),i=this.GlobalCart.cart.items.filter((({properties:t})=>t?._FreeGiftTieredDiscountId));let s=[],a=[],o=[],r=[];if(t){t.tiers=t.tiers.map((t=>{t.threshold=parseFloat(t.threshold),t.thresholdWithMultiplier=parseFloat(t.thresholdWithMultiplier);const i=t.calcDiscountTotal?this.GlobalCart.cart.total_price/(1-Number(t.amount)/100):e;return t.active=parseFloat((i/100).toFixed(2))>=t.thresholdWithMultiplier,t})),s=t.tiers.filter((({active:t})=>t)).map((t=>t.selectionData?.freeGift?.products?Object.values(t.selectionData.freeGift.products):[])).flat(2).map((t=>parseInt(t.split("/").reverse()[0]))),a=s,a=a.filter((e=>!i.some((i=>i.properties._FreeGiftTieredDiscountId==t.discountTitle&&i.variant_id==e))));const n=this.getSoldOutItems();a=a.filter((t=>{const e=n.includes(t),i=this.GlobalCart.getLineItemsByVariantId(t)?.map((({quantity:t})=>t)).reduce(((t,e)=>t+e),0)||0;return i>=6&&o.push(t),e&&r.push(t),!e&&i<6}))}const n=[];i.forEach((e=>{const i=this.GlobalCart.getLineItemsByVariantId(e.variant_id)?.map((({quantity:t})=>t)).reduce(((t,e)=>t+e),0)||0;!t||this.GlobalCart.freeGiftToggle.show&&this.GlobalCart.freeGiftToggle.remove||-1==s.indexOf(e.variant_id)||!this.GlobalCart.cart.total_price||i>6?(n.push({key:e.key,quantity:0}),!i>6&&o.push(e.variant_id)):e.quantity>1&&n.push({key:e.key,quantity:1})})),a={items:this.GlobalCart.freeGiftToggle.show&&this.GlobalCart.freeGiftToggle.remove?[]:a.map((e=>({id:e,quantity:1,properties:{_FreeGiftTieredDiscountId:t.discountTitle}})))};const l=this.GlobalCart.cart.items.filter((e=>e.properties?._FreeGiftTieredDiscountId&&e.properties?._FreeGiftTieredDiscountId!==t.discountTitle)).map((t=>t.key));l.length&&await this.GlobalCart.removeLineItemsByKey(l);try{a.items.length&&this.GlobalCart.cart.total_price&&await this.GlobalCart.addToCart(a),n.length&&this.GlobalCart.updateQty(null,null,n)}catch(t){}}}class GlobalFreeGiftToggle extends HTMLElement{constructor(){super()}connectedCallback(){DomReadyPromise().then((async()=>{const t=this.querySelector(":scope > template");if(t){try{this.settings=JSON.parse(t.innerHTML),t.remove()}catch(t){console.log(t)}if(!this.settings)return}this.mounted||(this.GlobalCartInstance=await new GlobalCart,this.DiscountsV2Util=await new DiscountsV2Util,this.mounted=!0,this.innerHTML=`\n      <div class="flex row-wrap align-center justify-space">\n        <label \n          class="block-rel"\n          for="remove_gifts">\n          <span>\n            ${this.settings.gift_remove__text}\n          </span>\n          <span class="tooltip"><i class="fa fa-question-circle"></i>\n            <span class="tooltiptext">\n              ${this.settings.remove__tooltip}\n            </span>\n          </span>\n        </label>\n        <label class="option-checktoggle">\n          <input \n            class="option-checktoggle__input" \n            name="removeGifts"\n            type="checkbox" \n            ${this.GlobalCartInstance.freeGiftToggle.remove?"":"checked"}>\n          <div class="option-checktoggle__control"></div>\n        </label>\n      </div>\n    `,this.checkbox=this.querySelector('[name="removeGifts"]'),this.checkbox.addEventListener("change",(()=>{this.GlobalCartInstance.freeGiftToggle.remove=!this.checkbox.checked,localStorage.setItem(this.GlobalCartInstance.freeGiftToggle.key,!this.checkbox.checked),this.DiscountsV2Util.updateCartFreeGifts()})),this.GlobalCartInstance.subscribe((({eventType:t})=>{this.toggleView()})),this.toggleView())})).catch((t=>{console.log(t)}))}async toggleView(){this.GlobalCartInstance.cart.items.some((t=>t.properties&&"_FreeGiftTieredDiscountId"in t.properties))||this.GlobalCartInstance.freeGiftToggle.remove?this.removeAttribute("hidden"):this.setAttribute("hidden",!0)}}customElements.define("global-freegift-toggle",GlobalFreeGiftToggle);var i=self;for(var s in e)i[s]=e[s];e.__esModule&&Object.defineProperty(i,"__esModule",{value:!0})})();